
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tensorshare.ts &#8212; tensorshare 0.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for tensorshare.ts</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Empty</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">Lock</span><span class="p">,</span> <span class="n">Condition</span>

<span class="kn">from</span> <span class="nn">tensorshare.ftp</span> <span class="kn">import</span> <span class="n">ClientCreator</span><span class="p">,</span> <span class="n">InMemoryFTPClient</span><span class="p">,</span> <span class="n">reactor</span><span class="p">,</span> <span class="n">FileSender</span><span class="p">,</span> <span class="n">BufferingProtocol</span><span class="p">,</span>\
    <span class="n">NotifyListenerFactory</span><span class="p">,</span> <span class="n">run_server</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="TensorShare"><a class="viewcode-back" href="../../tensorshare.html#tensorshare.ts.TensorShare">[docs]</a><span class="k">class</span> <span class="nc">TensorShare</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Creates a tensorshare instance.</span>

<span class="sd">    Args:</span>
<span class="sd">        host (str): the host of the tensorshare server</span>
<span class="sd">        port (int): the port of the tensorshare server</span>

<span class="sd">    The instance will try to connect to the server with the given ip and port.</span>
<span class="sd">    Requests are stored in a queue and processed asynchronously.</span>
<span class="sd">    Request results are delivered via callbacks provided with the requests.</span>
<span class="sd">    Requests will be worked off after starting the tensorshare instance by calling the :meth:`start &lt;tensorshare.ts.TensorShare.start&gt;` method.</span>
<span class="sd">    :meth:`start &lt;tensorshare.ts.TensorShare.start&gt;` is blocking and must be called in the main thread like so:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        from tensorshare import TensorShare, run_server</span>
<span class="sd">        from threading import Thread</span>

<span class="sd">        def your_code_here():</span>
<span class="sd">            try:</span>
<span class="sd">                pass</span>
<span class="sd">            finally:</span>
<span class="sd">                ts.stop()</span>

<span class="sd">        # This starts the server in the same process.</span>
<span class="sd">        # Ideally this is run in a separate process.</span>
<span class="sd">        run_server(8000, start_reactor=False)</span>
<span class="sd">        ts = TensorShare(&#39;localhost&#39;, 8000)</span>
<span class="sd">        Thread(target=your_code_here, deamon=True).start()</span>
<span class="sd">        ts.start()</span>

<span class="sd">    All processed requests report the result to the callbacks provided with the requests.</span>
<span class="sd">    All callback will be called with a dictionary containing the key &#39;status&#39;, which is either &#39;OK&#39; (see :attr:`STATUS_OK &lt;tensorshare.ts.TensorShare.STATUS_OK&gt;`)</span>
<span class="sd">    if the request has been processed successfully, or &#39;ERR&#39; (see :attr:`STATUS_ERR &lt;tensorshare.ts.TensorShare.STATUS_ERR&gt;`)</span>
<span class="sd">    if the request has failed for some reason.</span>
<span class="sd">    If the request failed, the reason is provided in the &#39;msg&#39; field.</span>
<span class="sd">    If any data is returned by the request (e.g. :meth:`get &lt;tensorshare.ts.TensorShare.get&gt;`, :meth:`peek &lt;tensorshare.ts.TensorShare.peek&gt;`, :meth:`list &lt;tensorshare.ts.TensorShare.list&gt;` methods), it will be returned in the &#39;data&#39; field.</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        from tensorshare import TensorShare, run_server</span>
<span class="sd">        from threading import Thread</span>


<span class="sd">        def example(ts):</span>
<span class="sd">            # Define callbacks</span>
<span class="sd">            def cb_put(resp):</span>
<span class="sd">                print(&quot;put response: Status =&quot;, resp[&#39;status&#39;])</span>
<span class="sd">                if resp[&#39;status&#39;] == ts.STATUS_ERR:</span>
<span class="sd">                    print(&quot;Got error:&quot;, resp[&#39;msg&#39;])</span>
<span class="sd">                # Call list after put is finished</span>
<span class="sd">                ts.list(cb_list)</span>

<span class="sd">            def cb_list(resp):</span>
<span class="sd">                print(&quot;list response: Status =&quot;, resp[&#39;status&#39;])</span>
<span class="sd">                if resp[&#39;status&#39;] == ts.STATUS_ERR:</span>
<span class="sd">                    print(&quot;Got error:&quot;, resp[&#39;msg&#39;])</span>
<span class="sd">                else:</span>
<span class="sd">                    print(&#39;list result:&#39;, resp[&#39;data&#39;]) # -&gt; {&#39;bin1&#39;: 1}</span>
<span class="sd">                # Shut down tensorshare, also stops run_server</span>
<span class="sd">                ts.stop()</span>

<span class="sd">            # Request to put data, calling cb_put with the result</span>
<span class="sd">            ts.put(&#39;bin1&#39;, list(range(5)), cb_put)</span>

<span class="sd">        run_server(8000, start_reactor=False)</span>
<span class="sd">        tmp = TensorShare(&#39;localhost&#39;, 8000)</span>
<span class="sd">        Thread(target=example, args(tmp, ), daemon=True).start()</span>
<span class="sd">        try:</span>
<span class="sd">            tmp.start()</span>
<span class="sd">        finally:</span>
<span class="sd">            tmp.stop()</span>

<span class="sd">    `tensorshare` supports any data-type that can be processed by</span>
<span class="sd">    `torch.load &lt;https://pytorch.org/docs/stable/generated/torch.load.html#torch.load&gt;`_ and</span>
<span class="sd">    `torch.save &lt;https://pytorch.org/docs/stable/generated/torch.save.html#torch.save&gt;`_.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">STATUS_OK</span> <span class="o">=</span> <span class="s1">&#39;OK&#39;</span>
    <span class="n">STATUS_ERR</span> <span class="o">=</span> <span class="s1">&#39;ERR&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InMemoryFTPClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_listener</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NotifyListenerFactory</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_th</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_listener_cbs</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="TensorShare.append"><a class="viewcode-back" href="../../tensorshare.html#tensorshare.ts.TensorShare.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">dict</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append the given object to the objects in the specified bin.</span>

<span class="sd">        If the request is successful and the bin is empty, this method behaves identically to :meth:`put &lt;tensorshare.ts.TensorShare.put&gt;`.</span>
<span class="sd">        If there is exactly one item in the bin, both objects are put in a list.</span>
<span class="sd">        Otherwise, the given object is appended to the pre-existing list.</span>
<span class="sd">        In any successful case, the callback is called with the following message :code:`{&#39;status&#39;: &#39;OK&#39;}`</span>

<span class="sd">        If any error occurs, the callback will instead be called with this message :code:`{&#39;status&#39;: &#39;ERR&#39;, &#39;msg&#39;: &#39;&lt;err_msg&gt;&#39;}`</span>

<span class="sd">        Args:</span>
<span class="sd">            bin (str): the bin to which the object will be appended</span>
<span class="sd">            obj (object): the object to append</span>
<span class="sd">            callback (Callable[[dict], None]) = None: A callback receiving the server&#39;s response.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cb_pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">((</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">bin</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">callback</span><span class="p">)))</span></div>

<div class="viewcode-block" id="TensorShare.put"><a class="viewcode-back" href="../../tensorshare.html#tensorshare.ts.TensorShare.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">dict</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Put the given object in the specified bin.</span>

<span class="sd">        If the request is successful and any data in the bin exists, it will be overwritten.</span>
<span class="sd">        The callback will be called with following message: :code:`{&#39;status&#39;: &#39;OK&#39;}`.</span>

<span class="sd">        If the request fails, the response will be formatted like :code:`{&#39;status&#39;: &#39;ERR&#39;, &#39;msg&#39;: &#39;&lt;err_msg&gt;&#39;}`.</span>

<span class="sd">        Args:</span>
<span class="sd">            bin (str): the bin to which the object will be appended</span>
<span class="sd">            obj (object): the object to append</span>
<span class="sd">            callback (Callable[[dict], None]): A callback receiving the server&#39;s response.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cb_pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">((</span><span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">bin</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">callback</span><span class="p">)))</span></div>

<div class="viewcode-block" id="TensorShare.get"><a class="viewcode-back" href="../../tensorshare.html#tensorshare.ts.TensorShare.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">dict</span><span class="p">],</span> <span class="kc">None</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Get and remove all data in the specified bin.</span>

<span class="sd">        If the bin does exist, all data in the bin is given to the callback as either a list of objects</span>
<span class="sd">        (if any appending happened in the bin), or as the object itself in the &#39;data&#39; field :code:`{&#39;status&#39;: &#39;OK&#39;, &#39;data&#39;: &lt;bin_content&gt;}`</span>
<span class="sd">        All data in the bin will be removed after the request has been processed by the server.</span>

<span class="sd">        If the bin is empty or any other error occurs, the request fails and call the callback :code:`{&#39;status&#39;: &#39;ERR&#39;, &#39;msg&#39;: &#39;&lt;err_msg&gt;&#39;}`</span>

<span class="sd">        Args:</span>
<span class="sd">            bin (str): the bin from which all objects are retrieved</span>
<span class="sd">            callback (Callable[[dict], None]): A callback receiving the server&#39;s response.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">((</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">bin</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="kc">True</span><span class="p">)))</span></div>

<div class="viewcode-block" id="TensorShare.peek"><a class="viewcode-back" href="../../tensorshare.html#tensorshare.ts.TensorShare.peek">[docs]</a>    <span class="k">def</span> <span class="nf">peek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bin</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">dict</span><span class="p">],</span> <span class="kc">None</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Get and keep all data in the specified bin.</span>

<span class="sd">        If the bin does exist, all data in the bin is given to the callback as either a list of objects</span>
<span class="sd">        (if any appending happened in the bin), or as the object itself in the &#39;data&#39; field :code:`{&#39;status&#39;: &#39;OK&#39;, &#39;data&#39;: &lt;bin_content&gt;}`</span>

<span class="sd">        If the bin does not exist or is empty or any other error occured, the request fails, calling the callback with</span>
<span class="sd">        a message formatted like :code:`{&#39;status&#39;: &#39;ERR&#39;, &#39;msg&#39;: &#39;&lt;err_msg&gt;&#39;}`.</span>

<span class="sd">        Args:</span>
<span class="sd">            bin (str): the bin from which all objects are retrieved</span>
<span class="sd">            callback (Callable[[dict], None]): A callback receiving the server&#39;s response.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">((</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">bin</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="kc">False</span><span class="p">)))</span></div>

<div class="viewcode-block" id="TensorShare.list"><a class="viewcode-back" href="../../tensorshare.html#tensorshare.ts.TensorShare.list">[docs]</a>    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">dict</span><span class="p">],</span> <span class="kc">None</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;List all bins and the number of items within each.</span>

<span class="sd">        If successful, the listing is given as a dictionary, to the callback in the &#39;data&#39; field:</span>
<span class="sd">         :code:`{&#39;status&#39;: &#39;OK&#39;, &#39;data&#39;: {&#39;&lt;bin_name&gt;&#39;: &lt;bin_length&gt;}}`</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            ts.put(&#39;bin1&#39;, [1,2,3])</span>
<span class="sd">            ts.put(&#39;bin1&#39;, [2,3,4])  # Overwrites all contents of bin1</span>
<span class="sd">            ts.list(lambda x: print(x[&#39;data&#39;]) # yields {&#39;bin1&#39;: 1}</span>
<span class="sd">            ts.append(&#39;bin1&#39;, [3,4,5])  # Appends data to the bin</span>
<span class="sd">            ts.list(lambda x: print(x[&#39;data&#39;]) # yields {&#39;bin1&#39;: 2}</span>
<span class="sd">            ts.peek(&#39;bin1&#39;, lambda x: print(x[&#39;data&#39;])</span>
<span class="sd">            ts.list(lambda x: print(x[&#39;data&#39;]) # yields {&#39;bin1&#39;: 2}</span>
<span class="sd">            ts.get(&#39;bin1&#39;, lambda x: print(x[&#39;data&#39;])</span>
<span class="sd">            ts.list(lambda x: print(x[&#39;data&#39;]) # yields {}</span>

<span class="sd">        If the request fails, the response will be formatted like:</span>
<span class="sd">         :code:`{&#39;status&#39;: &#39;ERR&#39;, &#39;msg&#39;: &#39;&lt;err_msg&gt;&#39;}`</span>


<span class="sd">        Args:</span>
<span class="sd">            callback (Callable[[dict], None]): A callback receiving the server&#39;s response.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">((</span><span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">callback</span><span class="p">,)))</span></div>

<div class="viewcode-block" id="TensorShare.delete"><a class="viewcode-back" href="../../tensorshare.html#tensorshare.ts.TensorShare.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">dict</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete all data in the bin.</span>

<span class="sd">        If no data is in the bin or the bin does not exist, this is a no-op.</span>

<span class="sd">        Args:</span>
<span class="sd">            bin (str): which bin to delete</span>
<span class="sd">            callback (Callable[[dict], None]): A callback receiving the server&#39;s response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cb_pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">((</span><span class="s1">&#39;del&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">bin</span><span class="p">,</span> <span class="n">callback</span><span class="p">)))</span></div>

<div class="viewcode-block" id="TensorShare.listen"><a class="viewcode-back" href="../../tensorshare.html#tensorshare.ts.TensorShare.listen">[docs]</a>    <span class="k">def</span> <span class="nf">listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">dict</span><span class="p">],</span> <span class="kc">None</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Start receiving write updates on the specified bin.</span>

<span class="sd">        Args:</span>
<span class="sd">            bin (str): the bin from which all objects are retrieved</span>
<span class="sd">            callback (Callable[[dict], None]): A callback receiving the server&#39;s response.</span>

<span class="sd">        Whenever a client modifies the specified bin, a message will be sent to the callback:</span>
<span class="sd">        :code:`{&#39;status&#39;: &#39;OK&#39;, &#39;bin&#39;: &#39;&lt;bin_name&gt;&#39;, &#39;n_items&#39;: len(&lt;bin_name&gt;)}`.</span>

<span class="sd">        If any error occurs during setup, the callback is called with status &#39;ERR&#39;:</span>
<span class="sd">        :code:`{&#39;status&#39;: &#39;ERR&#39;, &#39;msg&#39;: &#39;&lt;err_msg&gt;&#39;}`</span>

<span class="sd">        This method only works if the current machine is visible to the server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">((</span><span class="s1">&#39;listen&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">bin</span><span class="p">,</span> <span class="n">callback</span><span class="p">)))</span></div>

<div class="viewcode-block" id="TensorShare.ignore"><a class="viewcode-back" href="../../tensorshare.html#tensorshare.ts.TensorShare.ignore">[docs]</a>    <span class="k">def</span> <span class="nf">ignore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">dict</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop receiving write notifications on the given bin.</span>

<span class="sd">        Args:</span>
<span class="sd">            bin (str): the bin from which all objects are retrieved</span>
<span class="sd">            callback (Callable[[dict], None]): A callback receiving the server&#39;s response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cb_pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">((</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">bin</span><span class="p">,</span> <span class="n">callback</span><span class="p">)))</span></div>

<div class="viewcode-block" id="TensorShare.start"><a class="viewcode-back" href="../../tensorshare.html#tensorshare.ts.TensorShare.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Starts the client.</span>

<span class="sd">        This method is blocking and must be called from the `main thread`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Setup connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_listener</span> <span class="o">=</span> <span class="n">NotifyListenerFactory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_updated</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_listener</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Listen on same port as the FTP server</span>
        <span class="n">creator</span> <span class="o">=</span> <span class="n">ClientCreator</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">InMemoryFTPClient</span><span class="p">,</span> <span class="s1">&#39;anonymous&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">creator</span><span class="o">.</span><span class="n">connectTCP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="p">)</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cb_set_clt</span><span class="p">)</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cb_fail_connect</span><span class="p">)</span>
        <span class="c1"># Start thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_th</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="TensorShare.stop"><a class="viewcode-back" href="../../tensorshare.html#tensorshare.ts.TensorShare.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stops the client.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_listener</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clt</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
            <span class="n">d</span><span class="o">.</span><span class="n">addBoth</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">reactor</span><span class="o">.</span><span class="n">stop</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="nf">_bin_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="nb">bin</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="n">info</span>
        <span class="k">if</span> <span class="nb">bin</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listener_cbs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Got update for unregistered bin: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">bin</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_listener_cbs</span><span class="p">[</span><span class="nb">bin</span><span class="p">]({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATUS_OK</span><span class="p">,</span> <span class="s1">&#39;bin&#39;</span><span class="p">:</span> <span class="nb">bin</span><span class="p">,</span> <span class="s1">&#39;n_items&#39;</span><span class="p">:</span> <span class="n">num</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
            <span class="c1"># Wait until the connection to the server has been established</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># Get task</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Cmd: </span><span class="si">{}</span><span class="s1">, Current queue length: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="o">.</span><span class="n">qsize</span><span class="p">()))</span>

            <span class="c1"># Work off the task</span>
            <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">&#39;append&#39;</span><span class="p">:</span>
                <span class="nb">bin</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">callback</span> <span class="o">=</span> <span class="n">args</span>

                <span class="k">def</span> <span class="nf">tmp</span><span class="p">():</span>
                    <span class="n">d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clt</span><span class="o">.</span><span class="n">appendFile</span><span class="p">(</span><span class="nb">bin</span><span class="p">)</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cb_send_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_bytes</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">callback</span><span class="p">)</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cb_fail</span><span class="p">,</span> <span class="s1">&#39;Failed to append data: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">&#39;put&#39;</span><span class="p">:</span>
                <span class="nb">bin</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">callback</span> <span class="o">=</span> <span class="n">args</span>

                <span class="k">def</span> <span class="nf">tmp</span><span class="p">():</span>
                    <span class="n">d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clt</span><span class="o">.</span><span class="n">storeFile</span><span class="p">(</span><span class="nb">bin</span><span class="p">)</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cb_send_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_bytes</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">callback</span><span class="p">)</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cb_fail</span><span class="p">,</span> <span class="s1">&#39;Failed to put data: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">&#39;get&#39;</span><span class="p">:</span>
                <span class="nb">bin</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">rm</span> <span class="o">=</span> <span class="n">args</span>

                <span class="k">def</span> <span class="nf">tmp</span><span class="p">():</span>
                    <span class="n">protocol</span> <span class="o">=</span> <span class="n">BufferingProtocol</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">rm</span><span class="p">:</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clt</span><span class="o">.</span><span class="n">retrieveFile</span><span class="p">(</span><span class="nb">bin</span><span class="p">,</span> <span class="n">protocol</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clt</span><span class="o">.</span><span class="n">peekFile</span><span class="p">(</span><span class="nb">bin</span><span class="p">,</span> <span class="n">protocol</span><span class="p">)</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cb_recv_file</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cb_fail</span><span class="p">,</span> <span class="s1">&#39;Failed to retrieve data: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">&#39;list&#39;</span><span class="p">:</span>
                <span class="n">callback</span><span class="p">,</span> <span class="o">=</span> <span class="n">args</span>

                <span class="k">def</span> <span class="nf">tmp</span><span class="p">():</span>
                    <span class="n">protocol</span> <span class="o">=</span> <span class="n">BufferingProtocol</span><span class="p">()</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clt</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cb_recv_list</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cb_fail</span><span class="p">,</span> <span class="s1">&#39;Failed to list data: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">&#39;del&#39;</span><span class="p">:</span>
                <span class="nb">bin</span><span class="p">,</span> <span class="n">callback</span> <span class="o">=</span> <span class="n">args</span>

                <span class="k">def</span> <span class="nf">tmp</span><span class="p">():</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clt</span><span class="o">.</span><span class="n">removeFile</span><span class="p">(</span><span class="nb">bin</span><span class="p">)</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cb_success</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cb_fail</span><span class="p">,</span> <span class="s1">&#39;Failed to delete data: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">&#39;listen&#39;</span><span class="p">:</span>
                <span class="nb">bin</span><span class="p">,</span> <span class="n">callback</span> <span class="o">=</span> <span class="n">args</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_listener_cbs</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="n">callback</span>

                <span class="k">def</span> <span class="nf">tmp</span><span class="p">():</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clt</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="nb">bin</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_listener</span><span class="o">.</span><span class="n">get_port</span><span class="p">()))</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cb_success</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cb_fail</span><span class="p">,</span> <span class="s1">&#39;Failed to register as listener: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">&#39;ignore&#39;</span><span class="p">:</span>
                <span class="nb">bin</span><span class="p">,</span> <span class="n">callback</span> <span class="o">=</span> <span class="n">args</span>

                <span class="k">if</span> <span class="nb">bin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listener_cbs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listener_cbs</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span>

                <span class="k">def</span> <span class="nf">tmp</span><span class="p">():</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clt</span><span class="o">.</span><span class="n">ignore</span><span class="p">(</span><span class="nb">bin</span><span class="p">)</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cb_success</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cb_fail</span><span class="p">,</span> <span class="s1">&#39;Failed to unregister as listener: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Received invalid cmd: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_wait</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Invoke function from reactor thread</span>
            <span class="n">reactor</span><span class="o">.</span><span class="n">callFromThread</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

            <span class="c1"># wait until the request has been handled</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Runner exited.&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_to_bytes</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_from_bytes</span><span class="p">(</span><span class="n">byts</span><span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="n">byts</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">byts</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">_cb_pass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_cb_send_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">consumer</span><span class="p">,</span> <span class="n">file_obj</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callable</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">cb_finish</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
            <span class="n">consumer</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wait</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">callback</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATUS_OK</span><span class="p">})</span>

        <span class="n">FileSender</span><span class="p">()</span><span class="o">.</span><span class="n">beginFileTransfer</span><span class="p">(</span><span class="n">file_obj</span><span class="p">,</span> <span class="n">consumer</span><span class="p">)</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">cb_finish</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cb_fail</span><span class="p">,</span> <span class="s1">&#39;Failed to send file: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">consumer</span><span class="p">,</span> <span class="n">file_obj</span>

    <span class="k">def</span> <span class="nf">_cb_recv_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">BufferingProtocol</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callable</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATUS_OK</span><span class="p">,</span>
                   <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_bytes</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">buffer</span><span class="p">)}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cb_fail</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;Failed to decode response: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="n">callback</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">_cb_recv_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">BufferingProtocol</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callable</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATUS_OK</span><span class="p">,</span>
                   <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="nb">eval</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">))}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cb_fail</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;Failed to decode response: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="n">callback</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">_cb_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callable</span><span class="p">,</span> <span class="n">call_callback</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">call_callback</span><span class="p">:</span>
            <span class="n">callback</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATUS_OK</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">_cb_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callable</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">callback</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATUS_ERR</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="n">msg</span><span class="p">})</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_cb_set_clt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clt</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_cb_fail_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;Could not connect to the tensorshare server: </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="RLWorker"><a class="viewcode-back" href="../../tensorshare.html#tensorshare.ts.RLWorker">[docs]</a><span class="k">class</span> <span class="nc">RLWorker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Creates a :class:`RLWorker &lt;tensorshare.ts.RLWorker&gt;` instance that provides commonly used functionality in DDRL for rollout or self-play workers.</span>

<span class="sd">    The :class:`RLWorker &lt;tensorshare.ts.RLWorker&gt;` supports two main functionalities:</span>

<span class="sd">    1. retrieving latest network parameters (see :meth:`get_parameters &lt;tensorshare.ts.RLWorker.get_parameters&gt;`, and :meth:`await_new_parameters &lt;tensorshare.ts.RLWorker.await_new_parameters&gt;`)</span>
<span class="sd">    2. appending self-play or rollout data to the servers storage (see :meth:`add_data &lt;tensorshare.ts.RLWorker.add_data&gt;`)</span>

<span class="sd">    A local copy of the current network parameters is kept and returned to any thread requesting them without delay via :meth:`get_parameters &lt;tensorshare.ts.RLWorker.get_parameters&gt;`.</span>
<span class="sd">    Once a write update on these occurs, the :class:`RLWorker &lt;tensorshare.ts.RLWorker&gt;` will update the local copy immediately.</span>
<span class="sd">    Additionally, the parameter version is tracked and any data added to the server includes this version, allowing</span>
<span class="sd">    the :class:`RLTrainer &lt;tensorshare.ts.RLTrainer&gt;` to filter for on-policy samples.</span>

<span class="sd">    Publishing of data is non-blocking for callers of :meth:`add_data &lt;tensorshare.ts.RLWorker.add_data&gt;`.</span>

<span class="sd">    Lastly, waiting for parameter updates is supported :meth:`await_new_parameters &lt;tensorshare.ts.RLWorker.await_new_parameters&gt;`.</span>
<span class="sd">    This may be useful if the :class:`RLTrainer &lt;tensorshare.ts.RLTrainer&gt;` has not yet published any parameters yet or</span>
<span class="sd">    if the worker knows how many samples to produce util a new version is expected.</span>

<span class="sd">    Args:</span>
<span class="sd">        host (str): The host machine of the tensorshare server</span>
<span class="sd">        port (int): The port on which the tensorshare server listens</span>
<span class="sd">        host_server (bool): Whether or not to host the server in this process. This is included for testing purposes and should not be used in real training scenarios. In real training scenarios, start the server using :func:`start_server &lt;tensorshare.ftp.start_server&gt;` in a seperate process.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">host_server</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">host_server</span><span class="p">:</span>
            <span class="n">run_server</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">start_reactor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="n">TensorShare</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">peek</span><span class="p">(</span><span class="s1">&#39;parameters&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cb_update_parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s1">&#39;parameters&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cb_parameters_updated</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_last_retrieved_version</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_latest_params</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_latest_version</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span> <span class="o">=</span> <span class="n">Condition</span><span class="p">()</span>

<div class="viewcode-block" id="RLWorker.start"><a class="viewcode-back" href="../../tensorshare.html#tensorshare.ts.RLWorker.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Starts connecting to the tensorshare server.</span>

<span class="sd">        This methods is blocking and must be called from the main thread.</span>
<span class="sd">        Make sure to have the server running before calling this method and to also call</span>
<span class="sd">        :meth:`close &lt;tensorshare.ts.RLWorker.close&gt;` when exiting (e.g. using the try-finally pattern).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Blocking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

<div class="viewcode-block" id="RLWorker.stop"><a class="viewcode-back" href="../../tensorshare.html#tensorshare.ts.RLWorker.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ends the connection to the tensorshare server, freeing all resources in the process.</span>

<span class="sd">        This method should always be called after calling :meth:`start &lt;tensorshare.ts.RLWorker.start&gt;` to make sure</span>
<span class="sd">        the process can exit smoothly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This might still not finish if the server is hosted in this instance (until all conns are closed).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>

<div class="viewcode-block" id="RLWorker.add_data"><a class="viewcode-back" href="../../tensorshare.html#tensorshare.ts.RLWorker.add_data">[docs]</a>    <span class="k">def</span> <span class="nf">add_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds data to the tensorshare server, from which the :class:`RLTrainer &lt;tensorshare.ts.RLTrainer&gt;` can retrieve it.</span>

<span class="sd">        The data is send to the server in a separate process and is non-blocking.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (object): The data to add to the tensorshare server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_retrieved_version</span><span class="p">},</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="RLWorker.await_new_parameters"><a class="viewcode-back" href="../../tensorshare.html#tensorshare.ts.RLWorker.await_new_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">await_new_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]:</span>
        <span class="c1"># If no new parameters have been send, return without waiting</span>
        <span class="c1"># Else we wait until an update comes.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_retrieved_version</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_version</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">()</span></div>

<div class="viewcode-block" id="RLWorker.get_parameters"><a class="viewcode-back" href="../../tensorshare.html#tensorshare.ts.RLWorker.get_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">get_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_retrieved_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_version</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_params</span></div>

    <span class="k">def</span> <span class="nf">_cb_parameters_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;OK&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Initial connection success confirmation message</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;OK&#39;</span> <span class="ow">or</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;bin&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;parameters&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Got error on parameter update:&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">peek</span><span class="p">(</span><span class="s1">&#39;parameters&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cb_update_parameters</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_cb_update_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;OK&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Got error while retrieving parameters&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_latest_params</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_latest_version</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;version&#39;</span><span class="p">]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="o">.</span><span class="n">notifyAll</span><span class="p">()</span></div>


<div class="viewcode-block" id="RLTrainer"><a class="viewcode-back" href="../../tensorshare.html#tensorshare.ts.RLTrainer">[docs]</a><span class="k">class</span> <span class="nc">RLTrainer</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">host_server</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">filter_version</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">host_server</span><span class="p">:</span>
            <span class="n">run_server</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">start_reactor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="n">TensorShare</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_latest_version</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_versions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filter_version</span> <span class="o">=</span> <span class="n">filter_version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_th</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="RLTrainer.start"><a class="viewcode-back" href="../../tensorshare.html#tensorshare.ts.RLTrainer.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_th</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

<div class="viewcode-block" id="RLTrainer.stop"><a class="viewcode-back" href="../../tensorshare.html#tensorshare.ts.RLTrainer.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_th</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div>

<div class="viewcode-block" id="RLTrainer.get_data"><a class="viewcode-back" href="../../tensorshare.html#tensorshare.ts.RLTrainer.get_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_versions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">object</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">object</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
            <span class="n">versions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_versions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_versions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_version</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="n">versions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_version</span><span class="p">]</span>
            <span class="n">versions</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">versions</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_version</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">return_versions</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">versions</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="RLTrainer.publish_parameters"><a class="viewcode-back" href="../../tensorshare.html#tensorshare.ts.RLTrainer.publish_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">publish_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_latest_version</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;parameters&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_version</span><span class="p">},</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_version</span></div>

    <span class="k">def</span> <span class="nf">_cb_add_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;OK&#39;</span><span class="p">:</span>
            <span class="c1"># print(&quot;Error while retrieving data:&quot;, msg)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="c1"># print(&quot;got data:&quot;, msg[&#39;data&#39;][&#39;data&#39;], msg[&#39;data&#39;][&#39;version&#39;])</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_versions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_versions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;version&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cb_add_data</span><span class="p">)</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">tensorshare</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tensorshare.html">tensorshare package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Luca Reeb.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.4.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>